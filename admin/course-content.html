<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Content Management - LearnHub Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Design System -->
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .module-card {
            border-left: 4px solid var(--color-primary-500);
            transition: all 0.3s ease;
        }

        .module-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .content-item {
            padding: 12px;
            border-left: 3px solid #dee2e6;
            margin-left: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: var(--radius-base);
        }

        .content-item:hover {
            background: var(--color-neutral-50);
            border-left-color: var(--color-primary-500);
        }

        .item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .icon-video {
            background: #e3f2fd;
            color: #1976d2;
        }

        .icon-reading {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .icon-quiz {
            background: #fff3e0;
            color: #f57c00;
        }

        .icon-assignment {
            background: #e8f5e9;
            color: #388e3c;
        }


        /* Course Cards Redesign */
        .course-card {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            height: 100%;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            position: relative;
        }

        .course-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .course-card:hover .course-card-overlay {
            opacity: 1;
        }

        .course-card-header {
            height: 140px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .course-initials {
            font-size: 3rem;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: -1px;
            z-index: 1;
        }

        .course-card-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.3;
            background-image: radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.2) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .course-card-body {
            padding: 1.5rem;
            border-top: 1px solid var(--color-neutral-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-manage {
            background: var(--color-primary-500);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-manage:hover {
            background: var(--color-primary-600);
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <!-- Top Navbar -->
    <nav class="admin-navbar" role="navigation" aria-label="Admin navigation">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <i class="bi bi-list" aria-hidden="true"></i>
        </button>
        <a class="navbar-brand" href="dashboard.html">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>LearnHub Admin</span>
        </a>
        <div class="admin-navbar-end">
            <button class="btn btn-link text-dark me-2" id="adminThemeToggle" aria-label="Toggle dark mode"
                title="Toggle theme">
                <i class="bi bi-moon-fill"></i>
            </button>
            <div class="admin-user-info">
                <i class="bi bi-person-circle" aria-hidden="true"></i>
                <span id="adminName">Administrator</span>
            </div>
            <button class="admin-logout-btn" onclick="logout()">
                <i class="bi bi-box-arrow-right me-1" aria-hidden="true"></i> Logout
            </button>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <nav class="admin-sidebar-nav">
            <a href="dashboard.html" class="admin-nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="courses.html" class="admin-nav-item">
                <i class="bi bi-book"></i>
                <span>Courses</span>
            </a>
            <a href="course-content.html" class="admin-nav-item active">
                <i class="bi bi-collection"></i>
                <span>Course Content</span>
            </a>
            <a href="requests.html" class="admin-nav-item">
                <i class="bi bi-envelope"></i>
                <span>Requests</span>
            </a>
            <a href="students.html" class="admin-nav-item">
                <i class="bi bi-people"></i>
                <span>Students</span>
            </a>
            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(226, 232, 240, 0.1);">
                <a href="settings.html" class="admin-nav-item">
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main" id="main-content">
        <div class="admin-page-header">
            <h1 class="admin-page-title">Course Content Management</h1>
            <p class="text-muted mb-0">Manage modules and learning materials for your courses</p>
        </div>

        <!-- Course Selection Grid -->
        <div id="courseSelectionArea">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Select a Course</h4>
                <span class="text-muted" id="courseCount">0 courses</span>
            </div>
            <div id="coursesGrid" class="row g-4">
                <!-- Course cards will be loaded here -->
            </div>
            <div id="noCoursesState" class="admin-table-container text-center py-5 d-none">
                <i class="bi bi-book display-1 text-muted"></i>
                <h4 class="mt-3">No Courses Found</h4>
                <p class="text-muted">Create a course first in the Courses section</p>
                <a href="courses.html" class="btn btn-admin-primary">
                    <i class="bi bi-plus-circle me-2"></i>Go to Courses
                </a>
            </div>
        </div>

        <!-- Course Content Area -->
        <div id="contentArea" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <button class="btn btn-link text-decoration-none p-0 mb-2" onclick="backToCourseSelection()">
                        <i class="bi bi-arrow-left me-2"></i>Back to Courses
                    </button>
                    <h4 class="fw-bold mb-0" id="selectedCourseTitle">Course Modules</h4>
                </div>
                <button class="btn btn-admin-primary" onclick="showAddModuleModal()">
                    <i class="bi bi-plus-circle me-2"></i>Add Module
                </button>
            </div>

            <div id="modulesContainer">
                <!-- Modules will be loaded here -->
            </div>

            <div id="emptyState" class="admin-table-container text-center py-5 d-none">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="mt-3">No Modules Yet</h4>
                <p class="text-muted">Create your first module to start adding content</p>
                <button class="btn btn-admin-primary" onclick="showAddModuleModal()">
                    <i class="bi bi-plus-circle me-2"></i>Create First Module
                </button>
            </div>
        </div>
    </main>

    <!-- Add/Edit Module Modal -->
    <div class="modal fade" id="moduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moduleModalTitle">Add Module</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="moduleForm">
                        <input type="hidden" id="moduleId">
                        <div class="mb-3">
                            <label class="form-label required">Module Title</label>
                            <input type="text" class="form-control" id="moduleTitle"
                                placeholder="e.g., Week 1: Introduction to Python" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="moduleDescription" rows="3"
                                placeholder="Brief description of this module"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order</label>
                            <input type="number" class="form-control" id="moduleOrder" value="0" min="0">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="modulePublished">
                            <label class="form-check-label" for="modulePublished">
                                Publish (make visible to students)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-admin-primary" onclick="saveModule()">Save Module</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Content Item Modal -->
    <div class="modal fade" id="contentItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Content Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="itemModuleId">
                    <input type="hidden" id="itemId">

                    <!-- Content Type Selector -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Content Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="contentType" id="typeVideo" value="video"
                                checked>
                            <label class="btn btn-outline-primary" for="typeVideo">
                                <i class="bi bi-play-btn me-2"></i>Video
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeReading" value="reading">
                            <label class="btn btn-outline-primary" for="typeReading">
                                <i class="bi bi-book me-2"></i>Reading
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeQuiz" value="quiz">
                            <label class="btn btn-outline-primary" for="typeQuiz">
                                <i class="bi bi-question-circle me-2"></i>Quiz
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeAssignment"
                                value="assignment">
                            <label class="btn btn-outline-primary" for="typeAssignment">
                                <i class="bi bi-file-earmark-text me-2"></i>Assignment
                            </label>
                        </div>
                    </div>

                    <form id="contentItemForm">
                        <!-- Common Fields -->
                        <div class="mb-3">
                            <label class="form-label required">Title</label>
                            <input type="text" class="form-control" id="itemTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                        </div>

                        <!-- Video Fields -->
                        <div id="videoFields" class="content-type-fields">
                            <div class="mb-3">
                                <label class="form-label required">YouTube URL</label>
                                <input type="url" class="form-control" id="videoUrl"
                                    placeholder="https://www.youtube.com/watch?v=...">
                                <small class="text-muted">Paste the full YouTube video URL</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="videoDuration" min="1">
                            </div>
                        </div>

                        <!-- Reading Fields -->
                        <div id="readingFields" class="content-type-fields d-none">
                            <div class="mb-3">
                                <label class="form-label required">Content</label>
                                <textarea class="form-control" id="readingContent" rows="10"
                                    placeholder="Enter the reading content here..."></textarea>
                                <small class="text-muted">You can use basic HTML formatting</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estimated Reading Time (minutes)</label>
                                <input type="number" class="form-control" id="readingTime" min="1">
                            </div>
                        </div>

                        <!-- Quiz Fields -->
                        <div id="quizFields" class="content-type-fields d-none">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                After creating this quiz item, you'll be able to add questions to it.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Passing Score (%)</label>
                                <input type="number" class="form-control" id="quizPassingScore" value="70" min="0"
                                    max="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time Limit (minutes)</label>
                                <input type="number" class="form-control" id="quizTimeLimit"
                                    placeholder="Leave empty for no limit">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Attempts Allowed</label>
                                <input type="number" class="form-control" id="quizAttempts" value="3" min="1">
                            </div>
                        </div>

                        <!-- Assignment Fields -->
                        <div id="assignmentFields" class="content-type-fields d-none">
                            <div class="mb-3">
                                <label class="form-label required">Instructions</label>
                                <textarea class="form-control" id="assignmentInstructions" rows="6"
                                    placeholder="Detailed instructions for the assignment..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Score</label>
                                <input type="number" class="form-control" id="assignmentMaxScore" value="100" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="datetime-local" class="form-control" id="assignmentDueDate">
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="assignmentAllowLate" checked>
                                <label class="form-check-label" for="assignmentAllowLate">
                                    Allow late submissions
                                </label>
                            </div>
                        </div>

                        <!-- Common Fields -->
                        <div class="mb-3">
                            <label class="form-label">Order</label>
                            <input type="number" class="form-control" id="itemOrder" value="0" min="0">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="itemRequired" checked>
                            <label class="form-check-label" for="itemRequired">
                                Required (students must complete this)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-admin-primary" onclick="saveContentItem()">Save
                        Content</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/ui-utils.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        // Auth Check
        const adminUser = JSON.parse(localStorage.getItem('adminUser'));
        if (!adminUser || adminUser.role !== 'admin') window.location.href = 'login.html';

        // Display admin name
        if (adminUser && adminUser.full_name) {
            document.getElementById('adminName').textContent = adminUser.full_name;
        }

        // Setup theme toggle
        const themeToggle = document.getElementById('adminThemeToggle');
        const updateThemeIcon = () => {
            const theme = document.documentElement.getAttribute('data-theme');
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        };
        updateThemeIcon();
        themeToggle.addEventListener('click', () => {
            window.themeManager.toggle();
            updateThemeIcon();
        });

        function logout() { localStorage.removeItem('adminUser'); window.location.href = 'login.html'; }

        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
        }

        let currentCourseId = null;
        let moduleModal, contentItemModal;

        document.addEventListener('DOMContentLoaded', async () => {
            moduleModal = new bootstrap.Modal(document.getElementById('moduleModal'));
            contentItemModal = new bootstrap.Modal(document.getElementById('contentItemModal'));

            await loadCourses();
            setupContentTypeToggle();
        });

        async function loadCourses() {
            console.log('ðŸ” Loading courses...');
            const { data: courses, error } = await window.sb
                .from('courses')
                .select('id, title')
                .order('created_at', { ascending: false });

            console.log('ðŸ“Š Courses data:', courses);
            console.log('âŒ Error:', error);

            if (error) {
                console.error('Failed to load courses:', error);
                window.toast?.error('Failed to load courses');
                return;
            }

            const grid = document.getElementById('coursesGrid');
            const noCoursesState = document.getElementById('noCoursesState');
            const courseCount = document.getElementById('courseCount');

            if (!courses || courses.length === 0) {
                console.log('âš ï¸ No courses found or courses is null/empty');
                grid.innerHTML = '';
                noCoursesState.classList.remove('d-none');
                courseCount.textContent = '0 courses';
                return;
            }

            console.log(`âœ… Found ${courses.length} course(s)`);
            noCoursesState.classList.add('d-none');
            courseCount.textContent = `${courses.length} course${courses.length !== 1 ? 's' : ''}`;
            grid.innerHTML = courses.map(course => renderCourseCard(course)).join('');
        }


        function getCourseColor(title) {
            const colors = [
                ['#4F46E5', '#3730A3'], // Indigo
                ['#0EA5E9', '#0284C7'], // Sky
                ['#10B981', '#059669'], // Emerald
                ['#F59E0B', '#D97706'], // Amber
                ['#EC4899', '#DB2777'], // Pink
                ['#8B5CF6', '#7C3AED'], // Violet
                ['#F43F5E', '#E11D48'], // Rose
                ['#06B6D4', '#0891B2'], // Cyan
            ];
            let hash = 0;
            for (let i = 0; i < title.length; i++) {
                hash = title.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function getInitials(title) {
            return title
                .split(' ')
                .map(word => word[0])
                .slice(0, 2)
                .join('')
                .toUpperCase();
        }

        function renderCourseCard(course) {
            const title = course.title.replace(/'/g, "\'");
            const [bgStart, bgEnd] = getCourseColor(course.title);
            const initials = getInitials(course.title);

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="course-card" onclick="selectCourse('${course.id}', '${title}')">
                        <div class="course-card-header" style="background: linear-gradient(135deg, ${bgStart}, ${bgEnd})">
                            <div class="course-card-pattern"></div>
                            <div class="course-initials">${initials}</div>
                        </div>
                        <div class="course-card-body">
                            <div>
                                <h5 class="course-title">${course.title}</h5>
                                <p class="text-muted small mb-0">Click to manage content</p>
                            </div>
                            <div class="course-card-footer">
                                <span class="text-muted small">
                                    <i class="bi bi-collection-play me-1"></i> Manage Content
                                </span>
                                <button class="btn-manage">
                                    <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectCourse(courseId, courseTitle) {
            currentCourseId = courseId;
            document.getElementById('selectedCourseTitle').textContent = courseTitle;
            document.getElementById('courseSelectionArea').classList.add('d-none');
            document.getElementById('contentArea').classList.remove('d-none');
            loadCourseModules();
        }


        async function loadCourseModules() {
            if (!currentCourseId) {
                console.warn('âš ï¸ No course selected');
                document.getElementById('contentArea').classList.add('d-none');
                return;
            }

            console.log(`ðŸ” Loading modules for course: ${currentCourseId}`);
            document.getElementById('contentArea').classList.remove('d-none');

            const { data: modules, error } = await window.sb
                .from('course_modules')
                .select(`
                    *,
                    module_items (*)
                `)
                .eq('course_id', currentCourseId)
                .order('order_index');

            if (error) {
                console.error('âŒ Failed to load modules:', error);
                window.toast?.error('Failed to load modules');
                return;
            }

            const container = document.getElementById('modulesContainer');
            const emptyState = document.getElementById('emptyState');

            if (!modules || modules.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }

            emptyState.classList.add('d-none');
            container.innerHTML = modules.map(module => renderModule(module)).join('');
        }




        function renderModule(module) {
            const items = module.module_items || [];
            const itemsHtml = items
                .sort((a, b) => a.order_index - b.order_index)
                .map(item => renderContentItem(item)).join('');

            return `
                <div class="admin-table-container module-card mb-3">
                    <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 fw-bold">${module.title}</h5>
                            ${module.description ? `<p class="text-muted mb-0 small">${module.description}</p>` : ''}
                        </div>
                        <div>
                            <span class="badge ${module.is_published ? 'bg-success' : 'bg-secondary'} me-2">
                                ${module.is_published ? 'Published' : 'Draft'}
                            </span>
                            <button class="btn btn-sm btn-outline-primary" onclick="editModule('${module.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteModule('${module.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        ${itemsHtml || '<p class="text-muted mb-0">No content items yet</p>'}
                        <button class="btn btn-sm btn-admin-secondary mt-3" onclick="showAddContentModal('${module.id}')">
                            <i class="bi bi-plus me-2"></i>Add Content Item
                        </button>
                    </div>
                </div>
            `;
        }

        function renderContentItem(item) {
            const icons = {
                video: 'play-btn',
                reading: 'book',
                quiz: 'question-circle',
                assignment: 'file-earmark-text'
            };

            const iconClass = `icon-${item.type}`;
            const icon = icons[item.type] || 'file';

            return `
                <div class="content-item d-flex align-items-center mb-2">
                    <div class="item-icon ${iconClass} me-3">
                        <i class="bi bi-${icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${item.title}</div>
                        ${item.description ? `<small class="text-muted">${item.description}</small>` : ''}
                    </div>
                    <div>
                        ${item.is_required ? '<span class="badge bg-warning text-dark me-2">Required</span>' : ''}
                        <button class="btn btn-sm btn-link" onclick="editContentItem('${item.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-danger" onclick="deleteContentItem('${item.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function showAddModuleModal() {
            document.getElementById('moduleModalTitle').textContent = 'Add Module';
            document.getElementById('moduleForm').reset();
            document.getElementById('moduleId').value = '';
            moduleModal.show();
        }

        async function saveModule() {
            const moduleId = document.getElementById('moduleId').value;
            const moduleData = {
                course_id: currentCourseId,
                title: document.getElementById('moduleTitle').value,
                description: document.getElementById('moduleDescription').value,
                order_index: parseInt(document.getElementById('moduleOrder').value),
                is_published: document.getElementById('modulePublished').checked
            };

            console.log('ðŸ’¾ Saving module:', moduleData);

            let result;
            if (moduleId) {
                result = await window.sb
                    .from('course_modules')
                    .update(moduleData)
                    .eq('id', moduleId);
            } else {
                result = await window.sb
                    .from('course_modules')
                    .insert([moduleData]);
            }

            if (result.error) {
                console.error('âŒ Failed to save module:', result.error);
                window.toast?.error('Failed to save module');
                return;
            }

            console.log('âœ… Module saved successfully');
            window.toast?.success('Module saved successfully');
            moduleModal.hide();
            loadCourseModules();
        }

        async function deleteModule(moduleId) {
            if (!confirm('Are you sure you want to delete this module? All content items will be deleted.')) return;

            const { error } = await window.sb
                .from('course_modules')
                .delete()
                .eq('id', moduleId);

            if (error) {
                window.toast?.error('Failed to delete module');
                return;
            }

            window.toast?.success('Module deleted');
            loadCourseModules();
        }

        function showAddContentModal(moduleId) {
            document.getElementById('itemModuleId').value = moduleId;
            document.getElementById('contentItemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('typeVideo').checked = true;
            setupContentTypeToggle();
            contentItemModal.show();
        }

        function setupContentTypeToggle() {
            const typeRadios = document.querySelectorAll('input[name="contentType"]');
            typeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    document.querySelectorAll('.content-type-fields').forEach(el => el.classList.add('d-none'));
                    document.getElementById(`${radio.value}Fields`).classList.remove('d-none');
                });
            });
        }

        async function saveContentItem() {
            const itemId = document.getElementById('itemId').value;

            const type = document.querySelector('input[name="contentType"]:checked').value;
            const moduleId = document.getElementById('itemModuleId').value;

            const itemData = {
                module_id: moduleId,
                type: type,
                title: document.getElementById('itemTitle').value,
                description: document.getElementById('itemDescription').value,
                order_index: parseInt(document.getElementById('itemOrder').value),
                is_required: document.getElementById('itemRequired').checked,
                content: buildContentObject(type)
            };

            console.log('ðŸ’¾ Saving content item:', itemData);

            let result;
            if (itemId) {
                result = await window.sb
                    .from('module_items')
                    .update(itemData)
                    .eq('id', itemId);
            } else {
                result = await window.sb
                    .from('module_items')
                    .insert([itemData]);
            }

            if (result.error) {

                console.error('âŒ Failed to save content item:', result.error);
                window.toast?.error('Failed to save content item');
                console.error(error);
                return;
            }

            console.log('âœ… Content item saved successfully');
            window.toast?.success('Content item saved successfully');
            contentItemModal.hide();
            loadCourseModules();
        }

        function buildContentObject(type) {
            switch (type) {
                case 'video':
                    return {
                        youtube_url: document.getElementById('videoUrl').value,
                        duration: parseInt(document.getElementById('videoDuration').value) || null
                    };
                case 'reading':
                    return {
                        content_html: document.getElementById('readingContent').value,
                        estimated_time: parseInt(document.getElementById('readingTime').value) || null
                    };
                case 'quiz':
                    return {
                        passing_score: parseInt(document.getElementById('quizPassingScore').value),
                        time_limit: parseInt(document.getElementById('quizTimeLimit').value) || null,
                        attempts_allowed: parseInt(document.getElementById('quizAttempts').value)
                    };
                case 'assignment':
                    return {
                        instructions: document.getElementById('assignmentInstructions').value,
                        max_score: parseInt(document.getElementById('assignmentMaxScore').value),
                        due_date: document.getElementById('assignmentDueDate').value || null,
                        allow_late: document.getElementById('assignmentAllowLate').checked
                    };
            }
        }

        async function deleteContentItem(itemId) {
            if (!confirm('Are you sure you want to delete this content item?')) return;

            const { error } = await window.sb
                .from('module_items')
                .delete()
                .eq('id', itemId);

            if (error) {
                window.toast?.error('Failed to delete content item');
                return;
            }

            window.toast?.success('Content item deleted');
            loadCourseModules();
        }

        async function editModule(moduleId) {
            const { data: module, error } = await window.sb
                .from('course_modules')
                .select('*')
                .eq('id', moduleId)
                .single();

            if (error) {
                window.toast?.error('Failed to load module');
                return;
            }

            document.getElementById('moduleModalTitle').textContent = 'Edit Module';
            document.getElementById('moduleId').value = module.id;
            document.getElementById('moduleTitle').value = module.title;
            document.getElementById('moduleDescription').value = module.description || '';
            document.getElementById('moduleOrder').value = module.order_index;
            document.getElementById('modulePublished').checked = module.is_published;
            moduleModal.show();
        }

        async function editContentItem(itemId) {
            const { data: item, error } = await window.sb
                .from('module_items')
                .select('*')
                .eq('id', itemId)
                .single();

            if (error) {
                window.toast?.error('Failed to load content item');
                console.error('Error loading content item:', error);
                return;
            }

            document.getElementById('contentItemModalTitle').textContent = 'Edit Content Item';
            document.getElementById('contentItemForm').reset();
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemModuleId').value = item.module_id;

            // Populate common fields
            document.getElementById('itemTitle').value = item.title;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemOrder').value = item.order_index;
            document.getElementById('itemRequired').checked = item.is_required;

            // Set content type radio
            document.getElementById(`type${item.type.charAt(0).toUpperCase() + item.type.slice(1)}`).checked = true;

            // Show correct fields for the type
            document.querySelectorAll('.content-type-fields').forEach(el => el.classList.add('d-none'));
            document.getElementById(`${item.type}Fields`).classList.remove('d-none');

            // Populate type-specific fields
            if (item.content) {
                switch (item.type) {
                    case 'video':
                        document.getElementById('videoUrl').value = item.content.youtube_url || '';
                        document.getElementById('videoDuration').value = item.content.duration || '';
                        break;
                    case 'reading':
                        document.getElementById('readingContent').value = item.content.content_html || '';
                        document.getElementById('readingTime').value = item.content.estimated_time || '';
                        break;
                    case 'quiz':
                        document.getElementById('quizPassingScore').value = item.content.passing_score || '';
                        document.getElementById('quizTimeLimit').value = item.content.time_limit || '';
                        document.getElementById('quizAttempts').value = item.content.attempts_allowed || '';
                        break;
                    case 'assignment':
                        document.getElementById('assignmentInstructions').value = item.content.instructions || '';
                        document.getElementById('assignmentMaxScore').value = item.content.max_score || '';
                        document.getElementById('assignmentDueDate').value = item.content.due_date || '';
                        document.getElementById('assignmentAllowLate').checked = item.content.allow_late || false;
                        break;
                }
            }

            contentItemModal.show();
        }
    </script>
</body>

</html>