<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Content Management - LearnHub Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .module-card {
            border-left: 4px solid var(--color-primary-500);
            transition: all 0.3s ease;
        }

        .module-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .content-item {
            padding: 12px;
            border-left: 3px solid #dee2e6;
            margin-left: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .content-item:hover {
            background: var(--color-neutral-50);
            border-left-color: var(--color-primary-500);
        }

        .item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .icon-video {
            background: #e3f2fd;
            color: #1976d2;
        }

        .icon-reading {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .icon-quiz {
            background: #fff3e0;
            color: #f57c00;
        }

        .icon-assignment {
            background: #e8f5e9;
            color: #388e3c;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-mortarboard-fill me-2"></i>LearnHub Admin
            </a>
            <span class="navbar-text text-white">Course Content Management</span>
            <button class="btn btn-outline-light btn-sm ms-auto" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-light border-end" style="min-height: calc(100vh - 56px);">
                <div class="p-3">
                    <div class="list-group">
                        <a href="dashboard.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a>
                        <a href="courses.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-book me-2"></i>Courses
                        </a>
                        <a href="course-content.html" class="list-group-item list-group-item-action active">
                            <i class="bi bi-collection me-2"></i>Course Content
                        </a>
                        <a href="students.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-people me-2"></i>Students
                        </a>
                        <a href="requests.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-envelope me-2"></i>Requests
                        </a>
                        <a href="settings.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-gear me-2"></i>Settings
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold mb-0">Course Content Management</h2>
                </div>

                <!-- Course Selector -->
                <div class="card mb-4">
                    <div class="card-body">
                        <label class="form-label fw-bold">Select Course</label>
                        <select class="form-select form-select-lg" id="courseSelector" onchange="loadCourseModules()">
                            <option value="">-- Select a Course --</option>
                        </select>
                    </div>
                </div>

                <!-- Course Content Area -->
                <div id="contentArea" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0">Course Modules</h4>
                        <button class="btn btn-primary" onclick="showAddModuleModal()">
                            <i class="bi bi-plus-circle me-2"></i>Add Module
                        </button>
                    </div>

                    <div id="modulesContainer">
                        <!-- Modules will be loaded here -->
                    </div>

                    <div id="emptyState" class="text-center py-5 d-none">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="mt-3">No Modules Yet</h4>
                        <p class="text-muted">Create your first module to start adding content</p>
                        <button class="btn btn-primary" onclick="showAddModuleModal()">
                            <i class="bi bi-plus-circle me-2"></i>Create First Module
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Module Modal -->
    <div class="modal fade" id="moduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moduleModalTitle">Add Module</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="moduleForm">
                        <input type="hidden" id="moduleId">
                        <div class="mb-3">
                            <label class="form-label required">Module Title</label>
                            <input type="text" class="form-control" id="moduleTitle"
                                placeholder="e.g., Week 1: Introduction to Python" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="moduleDescription" rows="3"
                                placeholder="Brief description of this module"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order</label>
                            <input type="number" class="form-control" id="moduleOrder" value="0" min="0">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="modulePublished">
                            <label class="form-check-label" for="modulePublished">
                                Publish (make visible to students)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveModule()">Save Module</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Content Item Modal -->
    <div class="modal fade" id="contentItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Content Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="itemModuleId">
                    <input type="hidden" id="itemId">

                    <!-- Content Type Selector -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Content Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="contentType" id="typeVideo" value="video"
                                checked>
                            <label class="btn btn-outline-primary" for="typeVideo">
                                <i class="bi bi-play-btn me-2"></i>Video
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeReading" value="reading">
                            <label class="btn btn-outline-primary" for="typeReading">
                                <i class="bi bi-book me-2"></i>Reading
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeQuiz" value="quiz">
                            <label class="btn btn-outline-primary" for="typeQuiz">
                                <i class="bi bi-question-circle me-2"></i>Quiz
                            </label>

                            <input type="radio" class="btn-check" name="contentType" id="typeAssignment"
                                value="assignment">
                            <label class="btn btn-outline-primary" for="typeAssignment">
                                <i class="bi bi-file-earmark-text me-2"></i>Assignment
                            </label>
                        </div>
                    </div>

                    <form id="contentItemForm">
                        <!-- Common Fields -->
                        <div class="mb-3">
                            <label class="form-label required">Title</label>
                            <input type="text" class="form-control" id="itemTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                        </div>

                        <!-- Video Fields -->
                        <div id="videoFields" class="content-type-fields">
                            <div class="mb-3">
                                <label class="form-label required">YouTube URL</label>
                                <input type="url" class="form-control" id="videoUrl"
                                    placeholder="https://www.youtube.com/watch?v=...">
                                <small class="text-muted">Paste the full YouTube video URL</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="videoDuration" min="1">
                            </div>
                        </div>

                        <!-- Reading Fields -->
                        <div id="readingFields" class="content-type-fields d-none">
                            <div class="mb-3">
                                <label class="form-label required">Content</label>
                                <textarea class="form-control" id="readingContent" rows="10"
                                    placeholder="Enter the reading content here..."></textarea>
                                <small class="text-muted">You can use basic HTML formatting</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estimated Reading Time (minutes)</label>
                                <input type="number" class="form-control" id="readingTime" min="1">
                            </div>
                        </div>

                        <!-- Quiz Fields -->
                        <div id="quizFields" class="content-type-fields d-none">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                After creating this quiz item, you'll be able to add questions to it.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Passing Score (%)</label>
                                <input type="number" class="form-control" id="quizPassingScore" value="70" min="0"
                                    max="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time Limit (minutes)</label>
                                <input type="number" class="form-control" id="quizTimeLimit"
                                    placeholder="Leave empty for no limit">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Attempts Allowed</label>
                                <input type="number" class="form-control" id="quizAttempts" value="3" min="1">
                            </div>
                        </div>

                        <!-- Assignment Fields -->
                        <div id="assignmentFields" class="content-type-fields d-none">
                            <div class="mb-3">
                                <label class="form-label required">Instructions</label>
                                <textarea class="form-control" id="assignmentInstructions" rows="6"
                                    placeholder="Detailed instructions for the assignment..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Score</label>
                                <input type="number" class="form-control" id="assignmentMaxScore" value="100" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="datetime-local" class="form-control" id="assignmentDueDate">
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="assignmentAllowLate" checked>
                                <label class="form-check-label" for="assignmentAllowLate">
                                    Allow late submissions
                                </label>
                            </div>
                        </div>

                        <!-- Common Fields -->
                        <div class="mb-3">
                            <label class="form-label">Order</label>
                            <input type="number" class="form-control" id="itemOrder" value="0" min="0">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="itemRequired" checked>
                            <label class="form-check-label" for="itemRequired">
                                Required (students must complete this)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContentItem()">Save Content</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/ui-utils.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        // Auth Check
        const adminUser = JSON.parse(localStorage.getItem('adminUser'));
        if (!adminUser || adminUser.role !== 'admin') window.location.href = 'login.html';
        function logout() { localStorage.removeItem('adminUser'); window.location.href = 'login.html'; }

        let currentCourseId = null;
        let moduleModal, contentItemModal;

        document.addEventListener('DOMContentLoaded', async () => {
            moduleModal = new bootstrap.Modal(document.getElementById('moduleModal'));
            contentItemModal = new bootstrap.Modal(document.getElementById('contentItemModal'));

            await loadCourses();
            setupContentTypeToggle();
        });

        async function loadCourses() {
            const { data: courses, error } = await window.sb
                .from('courses')
                .select('id, title')
                .order('title');

            if (error) {
                window.toast?.error('Failed to load courses');
                return;
            }

            const selector = document.getElementById('courseSelector');
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                selector.appendChild(option);
            });
        }

        async function loadCourseModules() {
            const courseId = document.getElementById('courseSelector').value;
            if (!courseId) {
                document.getElementById('contentArea').classList.add('d-none');
                return;
            }

            currentCourseId = courseId;
            document.getElementById('contentArea').classList.remove('d-none');

            const { data: modules, error } = await window.sb
                .from('course_modules')
                .select(`
                    *,
                    module_items (*)
                `)
                .eq('course_id', courseId)
                .order('order_index');

            if (error) {
                window.toast?.error('Failed to load modules');
                return;
            }

            const container = document.getElementById('modulesContainer');
            const emptyState = document.getElementById('emptyState');

            if (!modules || modules.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }

            emptyState.classList.add('d-none');
            container.innerHTML = modules.map(module => renderModule(module)).join('');
        }

        function renderModule(module) {
            const items = module.module_items || [];
            const itemsHtml = items
                .sort((a, b) => a.order_index - b.order_index)
                .map(item => renderContentItem(item)).join('');

            return `
                <div class="card module-card mb-3">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">${module.title}</h5>
                            ${module.description ? `<small class="text-muted">${module.description}</small>` : ''}
                        </div>
                        <div>
                            <span class="badge ${module.is_published ? 'bg-success' : 'bg-secondary'}">
                                ${module.is_published ? 'Published' : 'Draft'}
                            </span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="editModule('${module.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteModule('${module.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${itemsHtml || '<p class="text-muted mb-0">No content items yet</p>'}
                        <button class="btn btn-sm btn-outline-primary mt-3" onclick="showAddContentModal('${module.id}')">
                            <i class="bi bi-plus me-2"></i>Add Content Item
                        </button>
                    </div>
                </div>
            `;
        }

        function renderContentItem(item) {
            const icons = {
                video: 'play-btn',
                reading: 'book',
                quiz: 'question-circle',
                assignment: 'file-earmark-text'
            };

            const iconClass = `icon-${item.type}`;
            const icon = icons[item.type] || 'file';

            return `
                <div class="content-item d-flex align-items-center mb-2">
                    <div class="item-icon ${iconClass} me-3">
                        <i class="bi bi-${icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${item.title}</div>
                        ${item.description ? `<small class="text-muted">${item.description}</small>` : ''}
                    </div>
                    <div>
                        ${item.is_required ? '<span class="badge bg-warning text-dark me-2">Required</span>' : ''}
                        <button class="btn btn-sm btn-link" onclick="editContentItem('${item.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-danger" onclick="deleteContentItem('${item.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function showAddModuleModal() {
            document.getElementById('moduleModalTitle').textContent = 'Add Module';
            document.getElementById('moduleForm').reset();
            document.getElementById('moduleId').value = '';
            moduleModal.show();
        }

        async function saveModule() {
            const moduleId = document.getElementById('moduleId').value;
            const moduleData = {
                course_id: currentCourseId,
                title: document.getElementById('moduleTitle').value,
                description: document.getElementById('moduleDescription').value,
                order_index: parseInt(document.getElementById('moduleOrder').value),
                is_published: document.getElementById('modulePublished').checked
            };

            let result;
            if (moduleId) {
                result = await window.sb
                    .from('course_modules')
                    .update(moduleData)
                    .eq('id', moduleId);
            } else {
                result = await window.sb
                    .from('course_modules')
                    .insert([moduleData]);
            }

            if (result.error) {
                window.toast?.error('Failed to save module');
                return;
            }

            window.toast?.success('Module saved successfully');
            moduleModal.hide();
            loadCourseModules();
        }

        async function deleteModule(moduleId) {
            if (!confirm('Are you sure you want to delete this module? All content items will be deleted.')) return;

            const { error } = await window.sb
                .from('course_modules')
                .delete()
                .eq('id', moduleId);

            if (error) {
                window.toast?.error('Failed to delete module');
                return;
            }

            window.toast?.success('Module deleted');
            loadCourseModules();
        }

        function showAddContentModal(moduleId) {
            document.getElementById('itemModuleId').value = moduleId;
            document.getElementById('contentItemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('typeVideo').checked = true;
            setupContentTypeToggle();
            contentItemModal.show();
        }

        function setupContentTypeToggle() {
            const typeRadios = document.querySelectorAll('input[name="contentType"]');
            typeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    document.querySelectorAll('.content-type-fields').forEach(el => el.classList.add('d-none'));
                    document.getElementById(`${radio.value}Fields`).classList.remove('d-none');
                });
            });
        }

        async function saveContentItem() {
            const type = document.querySelector('input[name="contentType"]:checked').value;
            const moduleId = document.getElementById('itemModuleId').value;

            const itemData = {
                module_id: moduleId,
                type: type,
                title: document.getElementById('itemTitle').value,
                description: document.getElementById('itemDescription').value,
                order_index: parseInt(document.getElementById('itemOrder').value),
                is_required: document.getElementById('itemRequired').checked,
                content: buildContentObject(type)
            };

            const { error } = await window.sb
                .from('module_items')
                .insert([itemData]);

            if (error) {
                window.toast?.error('Failed to save content item');
                console.error(error);
                return;
            }

            window.toast?.success('Content item saved successfully');
            contentItemModal.hide();
            loadCourseModules();
        }

        function buildContentObject(type) {
            switch (type) {
                case 'video':
                    return {
                        youtube_url: document.getElementById('videoUrl').value,
                        duration: parseInt(document.getElementById('videoDuration').value) || null
                    };
                case 'reading':
                    return {
                        content_html: document.getElementById('readingContent').value,
                        estimated_time: parseInt(document.getElementById('readingTime').value) || null
                    };
                case 'quiz':
                    return {
                        passing_score: parseInt(document.getElementById('quizPassingScore').value),
                        time_limit: parseInt(document.getElementById('quizTimeLimit').value) || null,
                        attempts_allowed: parseInt(document.getElementById('quizAttempts').value)
                    };
                case 'assignment':
                    return {
                        instructions: document.getElementById('assignmentInstructions').value,
                        max_score: parseInt(document.getElementById('assignmentMaxScore').value),
                        due_date: document.getElementById('assignmentDueDate').value || null,
                        allow_late: document.getElementById('assignmentAllowLate').checked
                    };
            }
        }

        async function deleteContentItem(itemId) {
            if (!confirm('Are you sure you want to delete this content item?')) return;

            const { error } = await window.sb
                .from('module_items')
                .delete()
                .eq('id', itemId);

            if (error) {
                window.toast?.error('Failed to delete content item');
                return;
            }

            window.toast?.success('Content item deleted');
            loadCourseModules();
        }
    </script>
</body>

</html>