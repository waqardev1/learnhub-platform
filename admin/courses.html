<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses - LearnHub Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <!-- Top Navbar -->
    <nav class="admin-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>
        <a class="navbar-brand" href="dashboard.html">
            <i class="bi bi-mortarboard-fill"></i>
            <span>LearnHub Admin</span>
        </a>
        <div class="admin-navbar-end">
            <div class="admin-user-info">
                <i class="bi bi-person-circle"></i>
                <span id="adminName">Administrator</span>
            </div>
            <button class="admin-logout-btn" onclick="logout()">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <nav class="admin-sidebar-nav">
            <a href="dashboard.html" class="admin-nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="courses.html" class="admin-nav-item active">
                <i class="bi bi-book"></i>
                <span>Courses</span>
            </a>
            <a href="requests.html" class="admin-nav-item">
                <i class="bi bi-envelope"></i>
                <span>Requests</span>
            </a>
            <a href="students.html" class="admin-nav-item">
                <i class="bi bi-people"></i>
                <span>Students</span>
            </a>
            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(226, 232, 240, 0.1);">
                <a href="settings.html" class="admin-nav-item">
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-page-header">
            <h1 class="admin-page-title">Manage Courses</h1>
            <button class="btn btn-admin-primary" onclick="openCourseModal()">
                <i class="bi bi-plus-lg me-2"></i>Add New Course
            </button>
        </div>

        <!-- Courses Table -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Duration</th>
                        <th>Visible</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="coursesTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Course Modal -->
    <div class="modal fade" id="courseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseModalTitle">Add Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="courseForm">
                        <input type="hidden" id="courseId">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Course Title</label>
                                <input type="text" class="form-control" id="courseTitle" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="courseCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="programming">Programming</option>
                                    <option value="design">Design</option>
                                    <option value="business">Business</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="data-science">Data Science</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Duration</label>
                                <input type="text" class="form-control" id="courseDuration" placeholder="e.g. 4 Weeks">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="courseTags"
                                    placeholder="e.g. beginner, web, javascript">
                                <small class="text-muted">Separate tags with commas</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="courseDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Outline (Markdown/Text)</label>
                            <textarea class="form-control" id="courseOutline" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Roadmap (Markdown/Text)</label>
                            <textarea class="form-control" id="courseRoadmap" rows="3"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">YouTube Playlist ID</label>
                                <input type="text" class="form-control" id="coursePlaylist">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Google Meet Link</label>
                                <input type="url" class="form-control" id="courseMeetLink">
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="courseVisible" checked>
                            <label class="form-check-label">Visible to Public</label>
                        </div>
                        <button type="submit" class="btn btn-admin-primary w-100">Save Course</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        // Auth Check
        const adminUser = JSON.parse(localStorage.getItem('adminUser'));
        if (!adminUser || adminUser.role !== 'admin') window.location.href = 'login.html';

        if (adminUser && adminUser.full_name) {
            document.getElementById('adminName').textContent = adminUser.full_name;
        }

        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
        }

        // Logic
        const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));

        document.addEventListener('DOMContentLoaded', loadCourses);

        async function loadCourses() {
            const { data: courses, error } = await window.sb.from('courses').select('*').order('created_at', { ascending: false });
            if (error) return alert('Error loading courses');

            const tbody = document.getElementById('coursesTableBody');
            if (!courses || courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No courses found</td></tr>';
                return;
            }

            tbody.innerHTML = courses.map(c => {
                const categoryBadge = c.category ? `<span class="badge bg-primary">${c.category.charAt(0).toUpperCase() + c.category.slice(1)}</span>` : '<span class="badge bg-secondary">Uncategorized</span>';
                return `
                <tr>
                    <td><strong>${c.title}</strong></td>
                    <td>${categoryBadge}</td>
                    <td>${c.duration || 'N/A'}</td>
                    <td>${c.is_visible ? '<span class="badge-admin success">Visible</span>' : '<span class="badge-admin secondary">Hidden</span>'}</td>
                    <td>
                        <button class="btn btn-admin-secondary btn-sm-admin me-1" onclick="editCourse('${c.id}')">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                        <button class="btn btn-admin-secondary btn-sm-admin" onclick="deleteCourse('${c.id}')" style="color: #dc2626;">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function openCourseModal() {
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('courseModalTitle').innerText = 'Add Course';
            courseModal.show();
        }

        window.editCourse = async (id) => {
            const { data, error } = await window.sb.from('courses').select('*').eq('id', id).single();
            if (error) return alert('Error fetching course');

            document.getElementById('courseId').value = data.id;
            document.getElementById('courseTitle').value = data.title;
            document.getElementById('courseCategory').value = data.category || '';
            document.getElementById('courseDuration').value = data.duration || '';
            document.getElementById('courseTags').value = data.tags || '';
            document.getElementById('courseDescription').value = data.description || '';
            document.getElementById('courseOutline').value = data.outline || '';
            document.getElementById('courseRoadmap').value = data.roadmap || '';
            document.getElementById('coursePlaylist').value = data.playlist_id || '';
            document.getElementById('courseMeetLink').value = data.meet_link || '';
            document.getElementById('courseVisible').checked = data.is_visible;

            document.getElementById('courseModalTitle').innerText = 'Edit Course';
            courseModal.show();
        }

        window.deleteCourse = async (id) => {
            if (!confirm('Are you sure you want to delete this course?')) return;
            const { error } = await window.sb.from('courses').delete().eq('id', id);
            if (error) alert('Error deleting course');
            else loadCourses();
        }

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('courseId').value;
            const formData = {
                title: document.getElementById('courseTitle').value,
                category: document.getElementById('courseCategory').value,
                duration: document.getElementById('courseDuration').value,
                tags: document.getElementById('courseTags').value,
                description: document.getElementById('courseDescription').value,
                outline: document.getElementById('courseOutline').value,
                roadmap: document.getElementById('courseRoadmap').value,
                playlist_id: document.getElementById('coursePlaylist').value,
                meet_link: document.getElementById('courseMeetLink').value,
                is_visible: document.getElementById('courseVisible').checked
            };

            let error;
            if (id) {
                ({ error } = await window.sb.from('courses').update(formData).eq('id', id));
            } else {
                ({ error } = await window.sb.from('courses').insert([formData]));
            }

            if (error) alert('Error saving course: ' + error.message);
            else {
                courseModal.hide();
                loadCourses();
            }
        });
    </script>
</body>

</html>