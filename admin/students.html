<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students - LearnHub Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <!-- Top Navbar -->
    <nav class="admin-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>
        <a class="navbar-brand" href="dashboard.html">
            <i class="bi bi-mortarboard-fill"></i>
            <span>LearnHub Admin</span>
        </a>
        <div class="admin-navbar-end">
            <div class="admin-user-info">
                <i class="bi bi-person-circle"></i>
                <span id="adminName">Administrator</span>
            </div>
            <button class="admin-logout-btn" onclick="logout()">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <nav class="admin-sidebar-nav">
            <a href="dashboard.html" class="admin-nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="courses.html" class="admin-nav-item">
                <i class="bi bi-book"></i>
                <span>Courses</span>
            </a>
            <a href="course-content.html" class="admin-nav-item">
                <i class="bi bi-collection"></i>
                <span>Course Content</span>
            </a>
            <a href="requests.html" class="admin-nav-item">
                <i class="bi bi-envelope"></i>
                <span>Requests</span>
            </a>
            <a href="students.html" class="admin-nav-item active">
                <i class="bi bi-people"></i>
                <span>Students</span>
            </a>
            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(226, 232, 240, 0.1);">
                <a href="settings.html" class="admin-nav-item">
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-page-header">
            <h1 class="admin-page-title">Registered Students</h1>
        </div>

        <!-- Students Table -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Password</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Enrolled Courses</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        // Auth Check
        const adminUser = JSON.parse(localStorage.getItem('adminUser'));
        if (!adminUser || adminUser.role !== 'admin') window.location.href = 'login.html';

        if (adminUser && adminUser.full_name) {
            document.getElementById('adminName').textContent = adminUser.full_name;
        }

        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', loadStudents);

        async function loadStudents() {
            const { data: students, error } = await window.sb
                .from('users')
                .select('*')
                .eq('role', 'student')
                .order('created_at', { ascending: false });

            if (error) return alert('Error loading students');

            const tbody = document.getElementById('studentsTableBody');
            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(s => `
                <tr>
                    <td><span class="badge-admin success">${s.user_id}</span></td>
                    <td><code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">${s.password}</code></td>
                    <td><strong>${s.full_name}</strong></td>
                    <td>${s.email || '-'}</td>
                    <td>
                        <span class="badge-admin secondary">
                            <i class="bi bi-book me-1"></i>${s.enrolled_courses ? s.enrolled_courses.length : 0} Course(s)
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-admin-secondary btn-sm-admin" onclick="deleteStudent('${s.id}')" style="color: #dc2626;">
                            <i class="bi bi-trash me-1"></i>Remove
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.deleteStudent = async (id) => {
            if (!confirm('Are you sure you want to remove this student? They will lose access.')) return;
            const { error } = await window.sb.from('users').delete().eq('id', id);
            if (error) alert('Error deleting student');
            else loadStudents();
        }
    </script>
</body>

</html>