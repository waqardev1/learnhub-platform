<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Student Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Design System -->
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Gamification badges */
        .achievement-showcase {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
            margin-bottom: var(--space-6);
        }

        .achievement-badge {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: white;
            border: 2px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            font-size: var(--text-sm);
            font-weight: var(--font-weight-semibold);
            transition: all var(--transition-base);
        }

        .achievement-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary-300);
        }

        .achievement-badge.streak {
            border-color: var(--color-warning-300);
            background: var(--color-warning-50);
        }

        .achievement-badge.completed {
            border-color: var(--color-success-300);
            background: var(--color-success-50);
        }

        .achievement-badge.top-learner {
            border-color: var(--color-primary-300);
            background: var(--color-primary-50);
        }

        .streak-counter {
            font-size: var(--text-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-warning-600);
        }

        /* Quick actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .quick-action-card {
            background: white;
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
            transition: all var(--transition-base);
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .quick-action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary-300);
            color: inherit;
        }

        .quick-action-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto var(--space-3);
            background: var(--color-primary-100);
            color: var(--color-primary-600);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }

        /* Mobile bottom nav */
        @media (max-width: 991px) {
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid var(--color-neutral-200);
                padding: var(--space-2) 0;
                z-index: var(--z-index-sticky);
                display: flex;
                justify-content: space-around;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--space-1);
                padding: var(--space-2);
                color: var(--color-neutral-500);
                text-decoration: none;
                font-size: var(--text-xs);
                transition: color var(--transition-fast);
            }

            .mobile-nav-item.active,
            .mobile-nav-item:hover {
                color: var(--color-primary-600);
            }

            .mobile-nav-item i {
                font-size: 1.25rem;
            }

            .main-content {
                padding-bottom: 80px;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                    <i class="bi bi-mortarboard-fill text-primary" aria-hidden="true"></i>
                    <span>LearnHub</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item-custom active" aria-current="page">
                    <i class="bi bi-grid-fill" aria-hidden="true"></i> Dashboard
                </a>
                <a href="#" class="nav-item-custom" onclick="event.preventDefault(); scrollToCourses();">
                    <i class="bi bi-journal-richtext" aria-hidden="true"></i> My Courses
                </a>
                <a href="../index.html#courses" class="nav-item-custom">
                    <i class="bi bi-search" aria-hidden="true"></i> Browse Courses
                </a>
                <a href="#" class="nav-item-custom" onclick="event.preventDefault(); showComingSoon();">
                    <i class="bi bi-trophy-fill" aria-hidden="true"></i> Achievements
                </a>
                <a href="#" class="nav-item-custom" onclick="event.preventDefault(); showComingSoon();">
                    <i class="bi bi-person-circle" aria-hidden="true"></i> Profile
                </a>
            </nav>
            <div class="p-4 border-top">
                <button class="btn btn-link text-dark w-100 mb-2" id="sidebarThemeToggle" aria-label="Toggle dark mode">
                    <i class="bi bi-moon-fill me-2"></i> Dark Mode
                </button>
                <button class="btn btn-outline-danger w-100" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-2" aria-hidden="true"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Mobile Toggle -->
            <div class="d-lg-none mb-4">
                <button class="btn btn-light shadow-sm" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                    <i class="bi bi-list fs-4"></i>
                </button>
            </div>

            <header class="mb-5 d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="fw-bold mb-1 h2">Welcome back, <span id="studentName">Student</span>! ðŸ‘‹</h1>
                    <p class="text-muted mb-0">Let's keep learning today.</p>
                </div>
                <div class="d-none d-md-block">
                    <span class="badge bg-white text-dark border px-3 py-2 rounded-pill">
                        <i class="bi bi-calendar-event me-2 text-primary" aria-hidden="true"></i>
                        <span id="currentDate"></span>
                    </span>
                </div>
            </header>

            <!-- Gamification Badges -->
            <div class="achievement-showcase" role="list" aria-label="Your achievements">
                <div class="achievement-badge streak" role="listitem">
                    <span class="streak-counter" id="streakDays">0</span>
                    <span>ðŸ”¥ Day Streak</span>
                </div>
                <div class="achievement-badge completed" role="listitem">
                    <i class="bi bi-trophy-fill text-success"></i>
                    <span><span id="badgeCount">0</span> Courses Completed</span>
                </div>
                <div class="achievement-badge top-learner" role="listitem">
                    <i class="bi bi-star-fill text-primary"></i>
                    <span>Top Learner</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions mb-5">
                <a href="../index.html#courses" class="quick-action-card">
                    <div class="quick-action-icon">
                        <i class="bi bi-plus-circle-fill"></i>
                    </div>
                    <h6 class="fw-semibold mb-1">Browse Courses</h6>
                    <p class="text-muted small mb-0">Explore new topics</p>
                </a>
                <a href="#" onclick="event.preventDefault(); scrollToCourses();" class="quick-action-card">
                    <div class="quick-action-icon"
                        style="background: var(--color-success-100); color: var(--color-success-600);">
                        <i class="bi bi-play-circle-fill"></i>
                    </div>
                    <h6 class="fw-semibold mb-1">Continue Learning</h6>
                    <p class="text-muted small mb-0">Resume your courses</p>
                </a>
                <a href="#" onclick="event.preventDefault(); showComingSoon();" class="quick-action-card">
                    <div class="quick-action-icon"
                        style="background: var(--color-warning-100); color: var(--color-warning-600);">
                        <i class="bi bi-calendar-check-fill"></i>
                    </div>
                    <h6 class="fw-semibold mb-1">Schedule</h6>
                    <p class="text-muted small mb-0">View upcoming classes</p>
                </a>
            </div>

            <!-- Stats Overview -->
            <div class="row g-4 mb-5">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-indigo-soft">
                            <i class="bi bi-book-fill"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0" id="enrolledCount">0</h3>
                            <p class="text-muted mb-0 small">Courses Enrolled</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-green-soft">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0" id="completedCount">0</h3>
                            <p class="text-muted mb-0 small">Completed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-amber-soft">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0" id="hoursLearned">0h</h3>
                            <p class="text-muted mb-0 small">Hours Learned</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Continue Learning Section -->
            <div id="continueLearningSection" class="mb-5 d-none">
                <h5 class="fw-bold mb-3">Continue Learning</h5>
                <div class="continue-learning-card">
                    <div class="row align-items-center position-relative" style="z-index: 1;">
                        <div class="col-md-8">
                            <span class="badge bg-white/20 text-white border border-white/20 mb-3">Last Accessed</span>
                            <h2 class="fw-bold mb-3 text-white" id="lastCourseTitle">Course Title</h2>
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="progress flex-grow-1"
                                    style="height: 8px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar bg-white" role="progressbar" style="width: 0%"
                                        id="lastCourseProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <span class="small fw-bold text-white" id="lastCourseProgressText">0% Complete</span>
                            </div>
                            <a href="#" id="lastCourseLink" class="btn btn-light text-primary fw-bold px-4 hover-lift">
                                Resume Course <i class="bi bi-arrow-right ms-2"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Courses Grid -->
            <h5 class="fw-bold mb-3" id="coursesHeader">My Courses</h5>
            <div id="enrolledCoursesGrid" class="row g-4">
                <!-- Courses loaded here -->
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav d-lg-none" role="navigation" aria-label="Mobile navigation">
        <a href="#" class="mobile-nav-item active">
            <i class="bi bi-grid-fill"></i>
            <span>Dashboard</span>
        </a>
        <a href="#" onclick="event.preventDefault(); scrollToCourses();" class="mobile-nav-item">
            <i class="bi bi-journal-richtext"></i>
            <span>Courses</span>
        </a>
        <a href="../index.html#courses" class="mobile-nav-item">
            <i class="bi bi-search"></i>
            <span>Browse</span>
        </a>
        <a href="#" onclick="event.preventDefault(); showComingSoon();" class="mobile-nav-item">
            <i class="bi bi-person-circle"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/ui-utils.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        // Auth Check
        const studentUser = JSON.parse(localStorage.getItem('studentUser'));
        if (!studentUser || studentUser.role !== 'student') window.location.href = 'login.html';

        function logout() {
            localStorage.removeItem('studentUser');
            window.location.href = 'login.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        function showComingSoon() {
            window.toast.info('This feature is coming soon!');
        }

        function scrollToCourses() {
            document.getElementById('coursesHeader').scrollIntoView({ behavior: 'smooth' });
        }

        // Set Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', options);
        document.getElementById('studentName').innerText = studentUser.full_name.split(' ')[0];

        // Setup theme toggle
        const themeToggle = document.getElementById('sidebarThemeToggle');
        const updateThemeIcon = () => {
            const theme = document.documentElement.getAttribute('data-theme');
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'bi bi-sun-fill me-2' : 'bi bi-moon-fill me-2';
            themeToggle.innerHTML = icon.outerHTML + (theme === 'dark' ? ' Light Mode' : ' Dark Mode');
        };
        updateThemeIcon();
        themeToggle.addEventListener('click', (e) => {
            e.preventDefault();
            window.themeManager.toggle();
            updateThemeIcon();
        });

        // Calculate and display streak
        function calculateStreak() {
            const lastVisit = localStorage.getItem('lastVisit');
            const today = new Date().toDateString();

            if (lastVisit === today) {
                return parseInt(localStorage.getItem('streak') || '1');
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastVisit === yesterday.toDateString()) {
                    const newStreak = parseInt(localStorage.getItem('streak') || '0') + 1;
                    localStorage.setItem('streak', newStreak);
                    localStorage.setItem('lastVisit', today);
                    return newStreak;
                } else {
                    localStorage.setItem('streak', '1');
                    localStorage.setItem('lastVisit', today);
                    return 1;
                }
            }
        }

        document.getElementById('streakDays').textContent = calculateStreak();

        document.addEventListener('DOMContentLoaded', loadEnrolledCourses);

        async function loadEnrolledCourses() {
            const grid = document.getElementById('enrolledCoursesGrid');
            window.LearnHubUI.LoadingManager.showSkeleton(grid, 'card', 3);

            const enrolledData = studentUser.enrolled_courses || [];

            // Normalize data
            const enrollments = enrolledData.map(item => {
                if (typeof item === 'string') {
                    return { course_id: item, progress: 0, last_accessed: null };
                }
                return item;
            });

            const courseIds = enrollments.map(e => e.course_id);
            document.getElementById('enrolledCount').innerText = courseIds.length;

            // Calculate Stats
            const completedCount = enrollments.filter(e => e.progress === 100).length;
            const totalHours = Math.round(enrollments.reduce((acc, curr) => acc + (10 * (curr.progress / 100)), 0));

            document.getElementById('completedCount').innerText = completedCount;
            document.getElementById('badgeCount').innerText = completedCount;
            document.getElementById('hoursLearned').innerText = totalHours + 'h';

            window.LearnHubUI.LoadingManager.removeSkeleton(grid);

            if (courseIds.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-journal-x"></i>
                            </div>
                            <h3 class="empty-state-title">No Courses Yet</h3>
                            <p class="empty-state-description">
                                You haven't enrolled in any courses yet. Browse our catalog to get started!
                            </p>
                            <div class="empty-state-action">
                                <a href="../index.html#courses" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Browse Courses
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Fetch course details
            const { data: courses, error } = await window.sb
                .from('courses')
                .select('*')
                .in('id', courseIds);

            if (error) {
                window.toast.error('Error loading courses');
                return;
            }

            // Find last accessed course
            const sortedEnrollments = [...enrollments].sort((a, b) =>
                new Date(b.last_accessed || 0) - new Date(a.last_accessed || 0)
            );
            const lastEnrollment = sortedEnrollments[0];
            const lastCourse = courses.find(c => c.id === lastEnrollment.course_id);

            if (lastCourse && lastEnrollment.last_accessed) {
                document.getElementById('lastCourseTitle').innerText = lastCourse.title;
                document.getElementById('lastCourseLink').href = `classroom.html?id=${lastCourse.id}`;
                document.getElementById('lastCourseProgress').style.width = `${lastEnrollment.progress}%`;
                document.getElementById('lastCourseProgress').setAttribute('aria-valuenow', lastEnrollment.progress);
                document.getElementById('lastCourseProgressText').innerText = `${lastEnrollment.progress}% Complete`;
                document.getElementById('continueLearningSection').classList.remove('d-none');
            }

            grid.innerHTML = courses.map(c => {
                const enrollment = enrollments.find(e => e.course_id === c.id) || { progress: 0 };
                return `
                <div class="col-md-6 col-xl-4">
                    <div class="card h-100 border-0 shadow-sm hover-lift">
                        <div class="card-body p-4 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge-custom badge-primary">Course</span>
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown" aria-label="Course options">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="../course-details.html?id=${c.id}">
                                            <i class="bi bi-info-circle me-2"></i>Course Details</a></li>
                                        <li><a class="dropdown-item" href="classroom.html?id=${c.id}">
                                            <i class="bi bi-play-circle me-2"></i>Go to Classroom</a></li>
                                    </ul>
                                </div>
                            </div>
                            <h5 class="card-title fw-bold mb-2">${c.title}</h5>
                            <p class="card-text text-muted small mb-4 flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${c.description || 'No description available.'}
                            </p>
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between small text-muted mb-2">
                                    <span>Progress</span>
                                    <span class="fw-semibold">${enrollment.progress}%</span>
                                </div>
                                <div class="progress-bar-container mb-4">
                                    <div class="progress-bar-fill" style="width: ${enrollment.progress}%"></div>
                                </div>
                                <a href="classroom.html?id=${c.id}" class="btn btn-primary w-100 fw-bold">
                                    ${enrollment.progress > 0 ? 'Continue' : 'Start'} 
                                    <i class="bi bi-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
    </script>
</body>

</html>